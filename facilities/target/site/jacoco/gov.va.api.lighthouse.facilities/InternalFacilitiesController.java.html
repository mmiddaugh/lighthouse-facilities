<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InternalFacilitiesController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">facilities</a> &gt; <a href="index.source.html" class="el_package">gov.va.api.lighthouse.facilities</a> &gt; <span class="el_source">InternalFacilitiesController.java</span></div><h1>InternalFacilitiesController.java</h1><pre class="source lang-java linenums">package gov.va.api.lighthouse.facilities;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkState;
import static gov.va.api.health.autoconfig.logging.LogSanitizer.sanitize;
import static gov.va.api.lighthouse.facilities.collector.Transformers.allBlank;
import static gov.va.api.lighthouse.facilities.collector.Transformers.isBlank;
import static java.util.stream.Collectors.toCollection;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Sets;
import com.google.common.collect.Streams;
import gov.va.api.health.autoconfig.logging.Loggable;
import gov.va.api.lighthouse.facilities.api.cms.CmsOverlay;
import gov.va.api.lighthouse.facilities.api.cms.DetailedService;
import gov.va.api.lighthouse.facilities.api.v0.Facility;
import gov.va.api.lighthouse.facilities.api.v0.ReloadResponse;
import gov.va.api.lighthouse.facilities.collector.FacilitiesCollector;
import java.time.Instant;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.TimeUnit;
import java.util.regex.Pattern;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

<span class="fc" id="L47">@Slf4j</span>
@Builder
@Validated
@RestController
@AllArgsConstructor(onConstructor = @__(@Autowired))
@RequestMapping(value = &quot;/internal/management&quot;, produces = &quot;application/json&quot;)
public class InternalFacilitiesController {
  static final String SPECIAL_INSTRUCTION_OLD_1 =
      &quot;Expanded or Nontraditional hours are available for some services on a routine and &quot;
          + &quot;or requested basis. Please call our main phone number for details.&quot;;

  static final String SPECIAL_INSTRUCTION_UPDATED_1 =
      &quot;More hours are available for some services. To learn more, call our main phone number.&quot;;

  static final String SPECIAL_INSTRUCTION_OLD_2 =
      &quot;Vet Center after hours assistance is &quot;
          + &quot;available by calling 1-877-WAR-VETS (1-877-927-8387).&quot;;

  static final String SPECIAL_INSTRUCTION_UPDATED_2 =
      &quot;If you need to talk to someone &quot;
          + &quot;or get advice right away, call the Vet Center anytime at 1-877-WAR-VETS &quot;
          + &quot;(1-877-927-8387).&quot;;

  static final String SPECIAL_INSTRUCTION_OLD_3 =
      &quot;Administrative hours are Monday-Friday 8:00 a.m. to 4:30 p.m.&quot;;

  static final String SPECIAL_INSTRUCTION_UPDATED_3 =
      &quot;Normal business hours are Monday through Friday, 8:00 a.m. to 4:30 p.m.&quot;;

  private static final String ZIP_REGEX = &quot;^[0-9]{5}(-[0-9]{4})?$&quot;;

<span class="fc" id="L78">  private static final Pattern ZIP_PATTERN = Pattern.compile(ZIP_REGEX);</span>

<span class="fc" id="L80">  private static final ObjectMapper MAPPER = FacilitiesJacksonConfig.createMapper();</span>

  private final FacilitiesCollector collector;

  private final FacilityRepository facilityRepository;

  private final FacilityGraveyardRepository graveyardRepository;

  private static Optional&lt;Facility.Address&gt; addressMailing(Facility facility) {
<span class="fc" id="L89">    return addresses(facility).map(a -&gt; a.mailing());</span>
  }

  private static Optional&lt;Facility.Address&gt; addressPhysical(Facility facility) {
<span class="fc" id="L93">    return addresses(facility).map(a -&gt; a.physical());</span>
  }

  private static Optional&lt;Facility.Addresses&gt; addresses(Facility facility) {
<span class="fc" id="L97">    return attributes(facility).map(a -&gt; a.address());</span>
  }

  private static Optional&lt;Facility.FacilityAttributes&gt; attributes(Facility facility) {
<span class="fc" id="L101">    return Optional.ofNullable(facility.attributes());</span>
  }

  private static boolean isHoursNull(Facility facility) {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">    return facility.attributes().hours() == null;</span>
  }

  /** Populate the given record with facility data _EXCEPT_ of the PK. */
<span class="nc" id="L109">  @SneakyThrows</span>
  static FacilityEntity populate(FacilityEntity record, Facility facility) {
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">    checkArgument(record.id() != null);</span>
<span class="fc" id="L112">    record.latitude(facility.attributes().latitude().doubleValue());</span>
<span class="fc" id="L113">    record.longitude(facility.attributes().longitude().doubleValue());</span>
    //    record.timeZone(facility.attributes().timeZone());
<span class="fc" id="L115">    record.state(stateOf(facility));</span>
<span class="fc" id="L116">    record.zip(zipOf(facility));</span>
<span class="fc" id="L117">    record.servicesFromServiceTypes(serviceTypesOf(facility));</span>
<span class="fc" id="L118">    record.facility(MAPPER.writeValueAsString(facility));</span>
<span class="fc" id="L119">    record.visn(facility.attributes().visn());</span>
<span class="fc" id="L120">    record.mobile(facility.attributes().mobile());</span>
<span class="fc" id="L121">    return record;</span>
  }

  /**
   * Determine the total collection of service types by combining health, benefits, and other
   * services types. This is guaranteed to return a non-null, but potentially empty collection.
   */
  static Set&lt;Facility.ServiceType&gt; serviceTypesOf(Facility facility) {
<span class="fc" id="L129">    var services = facility.attributes().services();</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">    if (services == null) {</span>
<span class="fc" id="L131">      return Set.of();</span>
    }
<span class="fc" id="L133">    var allServices = new HashSet&lt;Facility.ServiceType&gt;();</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">    if (services.health() != null) {</span>
<span class="fc" id="L135">      allServices.addAll(services.health());</span>
    }
<span class="fc bfc" id="L137" title="All 2 branches covered.">    if (services.benefits() != null) {</span>
<span class="fc" id="L138">      allServices.addAll(services.benefits());</span>
    }
<span class="fc bfc" id="L140" title="All 2 branches covered.">    if (services.other() != null) {</span>
<span class="fc" id="L141">      allServices.addAll(services.other());</span>
    }
<span class="fc" id="L143">    return allServices;</span>
  }

  private static Optional&lt;Facility.Services&gt; services(Facility facility) {
<span class="fc" id="L147">    return attributes(facility).map(a -&gt; a.services());</span>
  }

  /** Determine the state if available in a physical address, otherwise return null. */
  static String stateOf(Facility facility) {
<span class="fc bfc" id="L152" title="All 2 branches covered.">    if (facility.attributes().address() != null</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        &amp;&amp; facility.attributes().address().physical() != null</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">        &amp;&amp; isNotBlank(facility.attributes().address().physical().state())) {</span>
<span class="fc" id="L155">      return facility.attributes().address().physical().state();</span>
    }
<span class="fc" id="L157">    return null;</span>
  }

  /** Determine the 5 digit zip if available in a physical address, otherwise return null. */
  static String zipOf(Facility facility) {
<span class="fc bfc" id="L162" title="All 2 branches covered.">    if (facility.attributes().address() != null</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        &amp;&amp; facility.attributes().address().physical() != null</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        &amp;&amp; isNotBlank(facility.attributes().address().physical().zip())) {</span>
      /* We only store the destination portion of the zip code, we do not store the route. */
<span class="fc" id="L166">      return facility</span>
<span class="fc" id="L167">          .attributes()</span>
<span class="fc" id="L168">          .address()</span>
<span class="fc" id="L169">          .physical()</span>
<span class="fc" id="L170">          .zip()</span>
<span class="fc" id="L171">          .substring(0, Math.min(5, facility.attributes().address().physical().zip().length()));</span>
    }
<span class="fc" id="L173">    return null;</span>
  }

  @DeleteMapping(value = &quot;/facilities/{id}/cms-overlay&quot;)
  ResponseEntity&lt;Void&gt; deleteCmsOverlayById(@PathVariable(&quot;id&quot;) String id) {
<span class="fc" id="L178">    Optional&lt;FacilityEntity&gt; entity = entityById(id);</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">    if (entity.isEmpty()) {</span>
<span class="fc" id="L180">      log.info(&quot;Facility {} does not exist, ignoring request.&quot;, sanitize(id));</span>
<span class="fc" id="L181">      return ResponseEntity.accepted().build();</span>
    }
<span class="fc" id="L183">    log.info(&quot;Removing cmsOverlay from facility {}&quot;, sanitize(id));</span>
<span class="fc" id="L184">    facilityRepository.save(entity.get().cmsOperatingStatus(null));</span>
<span class="fc" id="L185">    facilityRepository.save(entity.get().overlayServices(null));</span>
<span class="fc" id="L186">    facilityRepository.save(entity.get().cmsServices(null));</span>
<span class="fc" id="L187">    return ResponseEntity.ok().build();</span>
  }

  @DeleteMapping(value = &quot;/facilities/{id}&quot;)
  ResponseEntity&lt;String&gt; deleteFacilityById(@PathVariable(&quot;id&quot;) String id) {
<span class="fc" id="L192">    Optional&lt;FacilityEntity&gt; entity = entityById(id);</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">    if (entity.isEmpty()) {</span>
<span class="fc" id="L194">      log.info(&quot;Facility {} does not exist, ignoring request.&quot;, sanitize(id));</span>
<span class="fc" id="L195">      return ResponseEntity.accepted().build();</span>
    }
<span class="fc bfc" id="L197" title="All 2 branches covered.">    if (entity.get().cmsOperatingStatus() != null</span>
<span class="pc bpc" id="L198" title="3 of 4 branches missed.">        || (entity.get().overlayServices() != null &amp;&amp; entity.get().overlayServices().size() != 0)</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        || entity.get().cmsServices() != null) {</span>
<span class="fc" id="L200">      log.info(</span>
          &quot;Failed to delete facility {}. cmsOperatingStatus, &quot;
              + &quot;overlayServices, or cmsServices are not null&quot;,
<span class="fc" id="L203">          sanitize(id));</span>
<span class="fc" id="L204">      return ResponseEntity.status(409)</span>
<span class="fc" id="L205">          .body(&quot;{\&quot;message\&quot;:\&quot;CMS Overlay must be deleted first.\&quot;}&quot;);</span>
    }
<span class="fc" id="L207">    log.info(&quot;Deleting facility {}&quot;, sanitize(id));</span>
<span class="fc" id="L208">    facilityRepository.delete(entity.get());</span>
<span class="fc" id="L209">    return ResponseEntity.ok().build();</span>
  }

  void deleteFromGraveyard(ReloadResponse response, FacilityGraveyardEntity entity) {
    try {
<span class="fc" id="L214">      graveyardRepository.delete(entity);</span>
<span class="fc" id="L215">    } catch (Exception e) {</span>
<span class="fc" id="L216">      log.error(</span>
          &quot;Failed to delete facility {} from graveyard: {}&quot;,
<span class="fc" id="L218">          entity.id().toIdString(),</span>
<span class="fc" id="L219">          e.getMessage());</span>
<span class="fc" id="L220">      response</span>
<span class="fc" id="L221">          .problems()</span>
<span class="fc" id="L222">          .add(</span>
<span class="fc" id="L223">              ReloadResponse.Problem.of(</span>
<span class="fc" id="L224">                  entity.id().toIdString(),</span>
<span class="fc" id="L225">                  &quot;Failed to delete facility from graveyard: &quot; + e.getMessage()));</span>
<span class="fc" id="L226">      throw e;</span>
<span class="fc" id="L227">    }</span>
<span class="fc" id="L228">  }</span>

  private Optional&lt;FacilityEntity&gt; entityById(String id) {
<span class="fc" id="L231">    FacilityEntity.Pk pk = null;</span>
    try {
<span class="fc" id="L233">      pk = FacilityEntity.Pk.fromIdString(id);</span>
<span class="nc" id="L234">    } catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L235">      return Optional.empty();</span>
<span class="fc" id="L236">    }</span>
<span class="fc" id="L237">    return facilityRepository.findById(pk);</span>
  }

  private String findAndReplaceOperationalHoursSpecialInstructions(String instructions) {
<span class="fc bfc" id="L241" title="All 2 branches covered.">    if (instructions == null) {</span>
<span class="fc" id="L242">      return null;</span>
    } else {
      // Look through the instructions for specific substrings and replace them if necessary
<span class="fc bfc" id="L245" title="All 2 branches covered.">      if (instructions.contains(SPECIAL_INSTRUCTION_OLD_1)) {</span>
<span class="fc" id="L246">        instructions =</span>
<span class="fc" id="L247">            instructions.replace(SPECIAL_INSTRUCTION_OLD_1, SPECIAL_INSTRUCTION_UPDATED_1);</span>
      }
<span class="fc bfc" id="L249" title="All 2 branches covered.">      if (instructions.contains(SPECIAL_INSTRUCTION_OLD_2)) {</span>
<span class="fc" id="L250">        instructions =</span>
<span class="fc" id="L251">            instructions.replace(SPECIAL_INSTRUCTION_OLD_2, SPECIAL_INSTRUCTION_UPDATED_2);</span>
      }
<span class="fc bfc" id="L253" title="All 2 branches covered.">      if (instructions.contains(SPECIAL_INSTRUCTION_OLD_3)) {</span>
<span class="fc" id="L254">        instructions =</span>
<span class="fc" id="L255">            instructions.replace(SPECIAL_INSTRUCTION_OLD_3, SPECIAL_INSTRUCTION_UPDATED_3);</span>
      }
    }
<span class="fc" id="L258">    return instructions;</span>
  }

  @GetMapping(&quot;/graveyard&quot;)
  GraveyardResponse graveyardAll() {
<span class="fc" id="L263">    return GraveyardResponse.builder()</span>
<span class="fc" id="L264">        .facilities(</span>
<span class="fc" id="L265">            Streams.stream(graveyardRepository.findAll())</span>
<span class="fc" id="L266">                .map(</span>
                    z -&gt;
<span class="fc" id="L268">                        GraveyardResponse.Item.builder()</span>
<span class="fc" id="L269">                            .facility(</span>
<span class="fc" id="L270">                                FacilitiesJacksonConfig.quietlyMap(</span>
<span class="fc" id="L271">                                    MAPPER, z.facility(), Facility.class))</span>
<span class="fc" id="L272">                            .cmsOverlay(</span>
<span class="fc" id="L273">                                CmsOverlay.builder()</span>
<span class="fc" id="L274">                                    .operatingStatus(</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                                        z.cmsOperatingStatus() == null</span>
<span class="nc" id="L276">                                            ? null</span>
<span class="fc" id="L277">                                            : FacilitiesJacksonConfig.quietlyMap(</span>
                                                MAPPER,
<span class="fc" id="L279">                                                z.cmsOperatingStatus(),</span>
                                                Facility.OperatingStatus.class))
<span class="fc" id="L281">                                    .detailedServices(</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">                                        z.cmsServices() == null</span>
<span class="nc" id="L283">                                            ? null</span>
<span class="fc" id="L284">                                            : List.of(</span>
<span class="fc" id="L285">                                                FacilitiesJacksonConfig.quietlyMap(</span>
                                                    MAPPER,
<span class="fc" id="L287">                                                    z.cmsServices(),</span>
                                                    DetailedService[].class)))
<span class="fc" id="L289">                                    .build())</span>
<span class="fc" id="L290">                            .overlayServices(z.graveyardOverlayServices())</span>
<span class="fc" id="L291">                            .missing(</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">                                z.missingTimestamp() == null</span>
<span class="nc" id="L293">                                    ? null</span>
<span class="fc" id="L294">                                    : Instant.ofEpochMilli(z.missingTimestamp()))</span>
<span class="fc" id="L295">                            .lastUpdated(z.lastUpdated())</span>
<span class="fc" id="L296">                            .build())</span>
<span class="fc" id="L297">                .collect(toList()))</span>
<span class="fc" id="L298">        .build();</span>
  }

  private Set&lt;FacilityEntity.Pk&gt; missingIds(List&lt;Facility&gt; collectedFacilities) {
<span class="fc" id="L302">    Set&lt;FacilityEntity.Pk&gt; newIds =</span>
<span class="fc" id="L303">        collectedFacilities.stream()</span>
<span class="fc" id="L304">            .map(f -&gt; FacilityEntity.Pk.optionalFromIdString(f.id()).orElse(null))</span>
<span class="fc" id="L305">            .filter(Objects::nonNull)</span>
<span class="fc" id="L306">            .collect(toCollection(LinkedHashSet::new));</span>
<span class="fc" id="L307">    Set&lt;FacilityEntity.Pk&gt; oldIds = new LinkedHashSet&lt;&gt;(facilityRepository.findAllIds());</span>
<span class="fc" id="L308">    return ImmutableSet.copyOf(Sets.difference(oldIds, newIds));</span>
  }

  private void moveToGraveyard(ReloadResponse response, FacilityEntity entity) {
<span class="fc" id="L312">    FacilityEntity.Pk id = FacilityEntity.Pk.of(entity.id().type(), entity.id().stationNumber());</span>
    try {
<span class="fc" id="L314">      Instant now = response.timing().completeCollection();</span>
<span class="fc" id="L315">      response.facilitiesRemoved().add(id.toIdString());</span>
<span class="fc" id="L316">      log.warn(&quot;Moving facility {} to graveyard.&quot;, id.toIdString());</span>
<span class="fc" id="L317">      graveyardRepository.save(</span>
<span class="fc" id="L318">          FacilityGraveyardEntity.builder()</span>
<span class="fc" id="L319">              .id(id)</span>
<span class="fc" id="L320">              .facility(entity.facility())</span>
<span class="fc" id="L321">              .cmsOperatingStatus(entity.cmsOperatingStatus())</span>
<span class="fc" id="L322">              .cmsServices(entity.cmsServices())</span>
<span class="fc" id="L323">              .graveyardOverlayServices(</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">                  entity.overlayServices() == null ? null : new HashSet&lt;&gt;(entity.overlayServices()))</span>
<span class="fc" id="L325">              .missingTimestamp(entity.missingTimestamp())</span>
<span class="fc" id="L326">              .lastUpdated(now)</span>
<span class="fc" id="L327">              .build());</span>
<span class="fc" id="L328">      facilityRepository.delete(entity);</span>
<span class="nc" id="L329">    } catch (Exception e) {</span>
<span class="nc" id="L330">      log.error(&quot;Failed to move facility {} to graveyard: {}&quot;, id.toIdString(), e.getMessage());</span>
<span class="nc" id="L331">      response</span>
<span class="nc" id="L332">          .problems()</span>
<span class="nc" id="L333">          .add(</span>
<span class="nc" id="L334">              ReloadResponse.Problem.of(</span>
<span class="nc" id="L335">                  id.toIdString(), &quot;Failed to move facility to graveyard: &quot; + e.getMessage()));</span>
<span class="nc" id="L336">      throw e;</span>
<span class="fc" id="L337">    }</span>
<span class="fc" id="L338">  }</span>

  private ResponseEntity&lt;ReloadResponse&gt; process(
      ReloadResponse response, List&lt;Facility&gt; collectedFacilities) {
<span class="fc" id="L342">    response.timing().markCompleteCollection();</span>
<span class="fc" id="L343">    log.info(&quot;Facilities collected: {}&quot;, collectedFacilities.size());</span>
    try {
<span class="fc" id="L345">      collectedFacilities.parallelStream().forEach(f -&gt; updateFacility(response, f));</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">      for (FacilityEntity.Pk missingId : missingIds(collectedFacilities)) {</span>
<span class="fc" id="L347">        processMissingFacility(response, missingId);</span>
<span class="fc" id="L348">      }</span>
<span class="nc" id="L349">    } catch (Exception e) {</span>
<span class="nc" id="L350">      log.error(&quot;Failed to process facilities: {}&quot;, e.getMessage());</span>
<span class="nc" id="L351">      return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);</span>
    } finally {
<span class="fc" id="L353">      response.timing().markComplete();</span>
    }
<span class="fc" id="L355">    return ResponseEntity.ok(response);</span>
  }

  private void processMissingFacility(ReloadResponse response, FacilityEntity.Pk id) {
<span class="fc" id="L359">    Optional&lt;FacilityEntity&gt; optEntity = facilityRepository.findById(id);</span>
<span class="fc" id="L360">    checkState(optEntity.isPresent());</span>
<span class="fc" id="L361">    FacilityEntity entity = optEntity.get();</span>
<span class="fc" id="L362">    Instant now = response.timing().completeCollection();</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">    if (entity.missingTimestamp() == null) {</span>
<span class="fc" id="L364">      entity.missingTimestamp(now.toEpochMilli());</span>
    }
<span class="fc bfc" id="L366" title="All 2 branches covered.">    if (now.toEpochMilli() - entity.missingTimestamp() &lt;= TimeUnit.HOURS.toMillis(24)) {</span>
<span class="fc" id="L367">      saveAsMissing(response, entity);</span>
<span class="fc" id="L368">      return;</span>
    }
<span class="fc" id="L370">    moveToGraveyard(response, entity);</span>
<span class="fc" id="L371">  }</span>

  @GetMapping(value = &quot;/reload&quot;)
  ResponseEntity&lt;ReloadResponse&gt; reload() {
<span class="fc" id="L375">    var response = ReloadResponse.start();</span>
<span class="fc" id="L376">    var collectedFacilities = collector.collectFacilities();</span>
<span class="fc" id="L377">    response.totalFacilities(collectedFacilities.size());</span>
<span class="fc" id="L378">    return process(response, collectedFacilities);</span>
  }

  private void saveAsMissing(ReloadResponse response, FacilityEntity entity) {
<span class="fc" id="L382">    FacilityEntity.Pk id = entity.id();</span>
    try {
<span class="fc" id="L384">      response.facilitiesMissing().add(id.toIdString());</span>
<span class="fc" id="L385">      log.warn(&quot;Marking facility {} as missing.&quot;, id.toIdString());</span>
<span class="fc" id="L386">      facilityRepository.save(entity);</span>
<span class="fc" id="L387">      return;</span>
<span class="nc" id="L388">    } catch (Exception e) {</span>
<span class="nc" id="L389">      log.error(&quot;Failed to mark facility {} as missing: {}&quot;, id.toIdString(), e.getMessage());</span>
<span class="nc" id="L390">      response</span>
<span class="nc" id="L391">          .problems()</span>
<span class="nc" id="L392">          .add(</span>
<span class="nc" id="L393">              ReloadResponse.Problem.of(</span>
<span class="nc" id="L394">                  id.toIdString(), &quot;Failed to mark facility as missing: &quot; + e.getMessage()));</span>
<span class="nc" id="L395">      throw e;</span>
    }
  }

<span class="fc" id="L399">  @SneakyThrows</span>
  void updateAndSave(ReloadResponse response, FacilityEntity record, Facility facility) {
<span class="fc" id="L401">    facility</span>
<span class="fc" id="L402">        .attributes()</span>
<span class="fc" id="L403">        .operationalHoursSpecialInstructions(</span>
<span class="fc" id="L404">            findAndReplaceOperationalHoursSpecialInstructions(</span>
<span class="fc" id="L405">                facility.attributes().operationalHoursSpecialInstructions()));</span>

<span class="fc" id="L407">    populate(record, facility);</span>
<span class="fc" id="L408">    record.missingTimestamp(null);</span>
<span class="fc" id="L409">    record.lastUpdated(response.timing().completeCollection());</span>
    /*
     * Determine if there is something wrong with the record, but it is still usable.
     */
<span class="fc bfc" id="L413" title="All 4 branches covered.">    if (isBlank(record.zip()) || !ZIP_PATTERN.matcher(record.zip()).matches()) {</span>
<span class="fc" id="L414">      response</span>
<span class="fc" id="L415">          .problems()</span>
<span class="fc" id="L416">          .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing or invalid physical address zip&quot;));</span>
    }
<span class="fc bfc" id="L418" title="All 2 branches covered.">    if (isBlank(record.state())) {</span>
<span class="fc" id="L419">      response</span>
<span class="fc" id="L420">          .problems()</span>
<span class="fc" id="L421">          .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing physical address state&quot;));</span>
    }
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">    if (isBlank(addressPhysical(facility).map(a -&gt; a.city()))) {</span>
<span class="fc" id="L424">      response</span>
<span class="fc" id="L425">          .problems()</span>
<span class="fc" id="L426">          .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing physical address city&quot;));</span>
    }
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">    if (allBlank(</span>
<span class="fc" id="L429">        addressPhysical(facility).map(a -&gt; a.address1()),</span>
<span class="fc" id="L430">        addressPhysical(facility).map(a -&gt; a.address2()),</span>
<span class="fc" id="L431">        addressPhysical(facility).map(a -&gt; a.address3()))) {</span>
<span class="fc" id="L432">      response</span>
<span class="fc" id="L433">          .problems()</span>
<span class="fc" id="L434">          .add(</span>
<span class="fc" id="L435">              ReloadResponse.Problem.of(</span>
<span class="fc" id="L436">                  facility.id(), &quot;Missing physical address street information&quot;));</span>
    }
    // Mailing addresses only exist for cemeteries
<span class="fc bfc" id="L439" title="All 2 branches covered.">    if (facility.attributes().facilityType() == Facility.FacilityType.va_cemetery) {</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">      if (isBlank(addressMailing(facility).map(a -&gt; a.zip()))</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">          || !ZIP_PATTERN.matcher(facility.attributes().address().mailing().zip()).matches()) {</span>
<span class="fc" id="L442">        response</span>
<span class="fc" id="L443">            .problems()</span>
<span class="fc" id="L444">            .add(</span>
<span class="fc" id="L445">                ReloadResponse.Problem.of(facility.id(), &quot;Missing or invalid mailing address zip&quot;));</span>
      }
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">      if (isBlank(addressMailing(facility).map(a -&gt; a.state()))) {</span>
<span class="fc" id="L448">        response</span>
<span class="fc" id="L449">            .problems()</span>
<span class="fc" id="L450">            .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing mailing address state&quot;));</span>
      }
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">      if (isBlank(addressMailing(facility).map(a -&gt; a.city()))) {</span>
<span class="fc" id="L453">        response</span>
<span class="fc" id="L454">            .problems()</span>
<span class="fc" id="L455">            .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing mailing address city&quot;));</span>
      }
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">      if (allBlank(</span>
<span class="fc" id="L458">          addressMailing(facility).map(a -&gt; a.address1()),</span>
<span class="fc" id="L459">          addressMailing(facility).map(a -&gt; a.address2()),</span>
<span class="fc" id="L460">          addressMailing(facility).map(a -&gt; a.address3()))) {</span>
<span class="fc" id="L461">        response</span>
<span class="fc" id="L462">            .problems()</span>
<span class="fc" id="L463">            .add(</span>
<span class="fc" id="L464">                ReloadResponse.Problem.of(</span>
<span class="fc" id="L465">                    facility.id(), &quot;Missing mailing address street information&quot;));</span>
      }
    }
<span class="pc bpc" id="L468" title="3 of 4 branches missed.">    if (facility.attributes().phone() == null || isBlank(facility.attributes().phone().main())) {</span>
<span class="fc" id="L469">      response</span>
<span class="fc" id="L470">          .problems()</span>
<span class="fc" id="L471">          .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing main phone number&quot;));</span>
    }
<span class="pc bpc" id="L473" title="3 of 4 branches missed.">    if (isHoursNull(facility) || isBlank(facility.attributes().hours().monday())) {</span>
<span class="fc" id="L474">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing hours Monday&quot;));</span>
    }
<span class="pc bpc" id="L476" title="3 of 4 branches missed.">    if (isHoursNull(facility) || isBlank(facility.attributes().hours().tuesday())) {</span>
<span class="fc" id="L477">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing hours Tuesday&quot;));</span>
    }
<span class="pc bpc" id="L479" title="3 of 4 branches missed.">    if (isHoursNull(facility) || isBlank(facility.attributes().hours().wednesday())) {</span>
<span class="fc" id="L480">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing hours Wednesday&quot;));</span>
    }
<span class="pc bpc" id="L482" title="3 of 4 branches missed.">    if (isHoursNull(facility) || isBlank(facility.attributes().hours().thursday())) {</span>
<span class="fc" id="L483">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing hours Thursday&quot;));</span>
    }
<span class="pc bpc" id="L485" title="3 of 4 branches missed.">    if (isHoursNull(facility) || isBlank(facility.attributes().hours().friday())) {</span>
<span class="fc" id="L486">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing hours Friday&quot;));</span>
    }
<span class="pc bpc" id="L488" title="3 of 4 branches missed.">    if (isHoursNull(facility) || isBlank(facility.attributes().hours().saturday())) {</span>
<span class="fc" id="L489">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing hours Saturday&quot;));</span>
    }
<span class="pc bpc" id="L491" title="3 of 4 branches missed.">    if (isHoursNull(facility) || isBlank(facility.attributes().hours().sunday())) {</span>
<span class="fc" id="L492">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing hours Sunday&quot;));</span>
    }
    // Currently classification is not populated for vet centers
<span class="fc bfc" id="L495" title="All 2 branches covered.">    if (facility.attributes().facilityType() != Facility.FacilityType.vet_center</span>
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">        &amp;&amp; isBlank(facility.attributes().classification())) {</span>
<span class="fc" id="L497">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing classification&quot;));</span>
    }
<span class="pc bpc" id="L499" title="1 of 4 branches missed.">    if (record.latitude() &gt; 90 || record.latitude() &lt; -90) {</span>
<span class="fc" id="L500">      response</span>
<span class="fc" id="L501">          .problems()</span>
<span class="fc" id="L502">          .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing or invalid location latitude&quot;));</span>
    }
<span class="pc bpc" id="L504" title="1 of 4 branches missed.">    if (record.longitude() &gt; 180 || record.longitude() &lt; -180) {</span>
<span class="fc" id="L505">      response</span>
<span class="fc" id="L506">          .problems()</span>
<span class="fc" id="L507">          .add(ReloadResponse.Problem.of(facility.id(), &quot;Missing or invalid location longitude&quot;));</span>
    }
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">    if ((facility.attributes().facilityType() == Facility.FacilityType.va_benefits_facility)</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">        &amp;&amp; isBlank(services(facility).map(s -&gt; s.benefits()))) {</span>
<span class="nc" id="L511">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing services&quot;));</span>
    }
<span class="fc bfc" id="L513" title="All 2 branches covered.">    if ((facility.attributes().facilityType() == Facility.FacilityType.va_health_facility)</span>
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">        &amp;&amp; isBlank(services(facility).map(s -&gt; s.health()))) {</span>
<span class="fc" id="L515">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing services&quot;));</span>
    }
<span class="fc bfc" id="L517" title="All 2 branches covered.">    if ((facility.attributes().facilityType() == Facility.FacilityType.va_health_facility</span>
<span class="fc bfc" id="L518" title="All 2 branches covered.">            || facility.attributes().facilityType() == Facility.FacilityType.vet_center)</span>
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">        &amp;&amp; isBlank(record.visn())) {</span>
<span class="fc" id="L520">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing VISN&quot;));</span>
    }
    try {
<span class="fc" id="L523">      facilityRepository.save(record);</span>
<span class="fc" id="L524">    } catch (Exception e) {</span>
<span class="fc" id="L525">      log.error(&quot;Failed to save facility record {}: {}&quot;, record.id(), e.getMessage());</span>
<span class="fc" id="L526">      log.error(&quot;{}&quot;, record);</span>
<span class="fc" id="L527">      response</span>
<span class="fc" id="L528">          .problems()</span>
<span class="fc" id="L529">          .add(</span>
<span class="fc" id="L530">              ReloadResponse.Problem.of(facility.id(), &quot;Failed to save record: &quot; + e.getMessage()));</span>
<span class="fc" id="L531">      throw e;</span>
<span class="fc" id="L532">    }</span>
<span class="fc" id="L533">  }</span>

  private void updateFacility(ReloadResponse response, Facility facility) {
    FacilityEntity.Pk pk;
    try {
<span class="fc" id="L538">      pk = FacilityEntity.Pk.fromIdString(facility.id());</span>
<span class="nc" id="L539">    } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L540">      log.error(&quot;Cannot process facility {}, ID not understood&quot;, facility.id(), e);</span>
<span class="nc" id="L541">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Cannot parse ID&quot;));</span>
<span class="nc" id="L542">      return;</span>
<span class="fc" id="L543">    }</span>
<span class="pc bpc" id="L544" title="1 of 4 branches missed.">    if (facility.attributes().latitude() == null || facility.attributes().longitude() == null) {</span>
<span class="fc" id="L545">      log.error(&quot;Cannot process facility {}, latitude and/or longitude is null&quot;, facility.id());</span>
<span class="fc" id="L546">      response.problems().add(ReloadResponse.Problem.of(facility.id(), &quot;Missing coordinates&quot;));</span>
<span class="fc" id="L547">      return;</span>
    }
<span class="fc" id="L549">    var existing = facilityRepository.findById(pk);</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">    if (existing.isPresent()) {</span>
<span class="fc" id="L551">      response.facilitiesUpdated().add(facility.id());</span>
<span class="fc" id="L552">      log.warn(&quot;Updating facility {}&quot;, facility.id());</span>
<span class="fc" id="L553">      updateAndSave(response, existing.get(), facility);</span>
<span class="fc" id="L554">      return;</span>
    }
<span class="fc" id="L556">    var zombie = graveyardRepository.findById(pk);</span>
<span class="fc bfc" id="L557" title="All 2 branches covered.">    if (zombie.isPresent()) {</span>
<span class="fc" id="L558">      response.facilitiesRevived().add(facility.id());</span>
<span class="fc" id="L559">      log.warn(&quot;Reviving facility {}&quot;, facility.id());</span>
<span class="fc" id="L560">      FacilityGraveyardEntity zombieEntity = zombie.get();</span>
      // only thing to retain from graveyard is CMS overlay
      // all other fields will be populated in updateAndSave()
      FacilityEntity facilityEntity =
<span class="fc" id="L564">          FacilityEntity.builder()</span>
<span class="fc" id="L565">              .id(pk)</span>
<span class="fc" id="L566">              .cmsOperatingStatus(zombieEntity.cmsOperatingStatus())</span>
<span class="fc" id="L567">              .cmsServices(zombieEntity.cmsServices())</span>
<span class="fc" id="L568">              .overlayServices(</span>
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">                  zombieEntity.graveyardOverlayServices() == null</span>
<span class="nc" id="L570">                      ? null</span>
<span class="fc" id="L571">                      : new HashSet&lt;&gt;(zombieEntity.graveyardOverlayServices()))</span>
<span class="fc" id="L572">              .build();</span>
<span class="fc" id="L573">      updateAndSave(response, facilityEntity, facility);</span>
<span class="fc" id="L574">      deleteFromGraveyard(response, zombieEntity);</span>
<span class="fc" id="L575">      return;</span>
    }
<span class="fc" id="L577">    response.facilitiesCreated().add(facility.id());</span>
<span class="fc" id="L578">    log.warn(&quot;Creating new facility {}&quot;, facility.id());</span>
<span class="fc" id="L579">    updateAndSave(response, FacilityEntity.builder().id(pk).build(), facility);</span>
<span class="fc" id="L580">  }</span>

  @PostMapping(value = &quot;/reload&quot;)
  @Loggable(arguments = false)
  ResponseEntity&lt;ReloadResponse&gt; upload(@RequestBody List&lt;Facility&gt; collectedFacilities) {
<span class="fc" id="L585">    var response = ReloadResponse.start();</span>
<span class="fc" id="L586">    return process(response, collectedFacilities);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>