<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HealthTransformer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">facilities</a> &gt; <a href="index.source.html" class="el_package">gov.va.api.lighthouse.facilities.collector</a> &gt; <span class="el_source">HealthTransformer.java</span></div><h1>HealthTransformer.java</h1><pre class="source lang-java linenums">package gov.va.api.lighthouse.facilities.collector;

import static gov.va.api.lighthouse.facilities.collector.Transformers.allBlank;
import static gov.va.api.lighthouse.facilities.collector.Transformers.checkAngleBracketNull;
import static gov.va.api.lighthouse.facilities.collector.Transformers.emptyToNull;
import static gov.va.api.lighthouse.facilities.collector.Transformers.hoursToClosed;
import static gov.va.api.lighthouse.facilities.collector.Transformers.isBlank;
import static gov.va.api.lighthouse.facilities.collector.Transformers.phoneTrim;
import static java.util.stream.Collectors.toCollection;
import static org.apache.commons.lang3.StringUtils.compareIgnoreCase;
import static org.apache.commons.lang3.StringUtils.equalsIgnoreCase;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.length;
import static org.apache.commons.lang3.StringUtils.trimToEmpty;
import static org.apache.commons.lang3.StringUtils.upperCase;

import com.google.common.collect.ListMultimap;
import gov.va.api.lighthouse.facilities.api.v0.Facility;
import gov.va.api.lighthouse.facilities.api.v0.Facility.PatientWaitTime;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.TreeMap;
import lombok.Builder;
import lombok.NonNull;
import org.apache.commons.lang3.BooleanUtils;

@Builder
final class HealthTransformer {
<span class="fc" id="L36">  private static final Map&lt;String, Facility.HealthService&gt; HEALTH_SERVICES =</span>
<span class="fc" id="L37">      initHealthServicesMap();</span>

  @NonNull private final VastEntity vast;

  @NonNull private final ListMultimap&lt;String, AccessToCareEntry&gt; accessToCare;

  @NonNull private final ListMultimap&lt;String, AccessToPwtEntry&gt; accessToPwt;

  @NonNull private final Map&lt;String, String&gt; mentalHealthPhoneNumbers;

  @NonNull private final ListMultimap&lt;String, StopCode&gt; stopCodesMap;

  @NonNull private final Map&lt;String, String&gt; websites;

  @NonNull private final ArrayList&lt;String&gt; cscFacilities;

  private static Map&lt;String, Facility.HealthService&gt; initHealthServicesMap() {
<span class="fc" id="L54">    Map&lt;String, Facility.HealthService&gt; map = new TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</span>
<span class="fc" id="L55">    map.put(&quot;AUDIOLOGY&quot;, Facility.HealthService.Audiology);</span>
<span class="fc" id="L56">    map.put(&quot;CARDIOLOGY&quot;, Facility.HealthService.Cardiology);</span>
<span class="fc" id="L57">    map.put(&quot;COMP WOMEN'S HLTH&quot;, Facility.HealthService.WomensHealth);</span>
<span class="fc" id="L58">    map.put(&quot;DERMATOLOGY&quot;, Facility.HealthService.Dermatology);</span>
<span class="fc" id="L59">    map.put(&quot;GASTROENTEROLOGY&quot;, Facility.HealthService.Gastroenterology);</span>
<span class="fc" id="L60">    map.put(&quot;GYNECOLOGY&quot;, Facility.HealthService.Gynecology);</span>
<span class="fc" id="L61">    map.put(&quot;MENTAL HEALTH&quot;, Facility.HealthService.MentalHealthCare);</span>
<span class="fc" id="L62">    map.put(&quot;OPHTHALMOLOGY&quot;, Facility.HealthService.Ophthalmology);</span>
<span class="fc" id="L63">    map.put(&quot;OPTOMETRY&quot;, Facility.HealthService.Optometry);</span>
<span class="fc" id="L64">    map.put(&quot;ORTHOPEDICS&quot;, Facility.HealthService.Orthopedics);</span>
<span class="fc" id="L65">    map.put(&quot;PRIMARY CARE&quot;, Facility.HealthService.PrimaryCare);</span>
<span class="fc" id="L66">    map.put(&quot;SPECIALTY CARE&quot;, Facility.HealthService.SpecialtyCare);</span>
<span class="fc" id="L67">    map.put(&quot;UROLOGY CLINIC&quot;, Facility.HealthService.Urology);</span>
<span class="fc" id="L68">    return map;</span>
  }

  private static Facility.HealthService serviceName(AccessToCareEntry atc) {
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">    return atc == null ? null : HEALTH_SERVICES.get(trimToEmpty(atc.apptTypeName()));</span>
  }

  private static LocalDate sliceToDate(String slice) {
<span class="fc bfc" id="L76" title="All 2 branches covered.">    return length(slice) &lt;= 9 ? null : LocalDate.parse(slice.substring(0, 10));</span>
  }

  private static Facility.PatientWaitTime waitTime(AccessToCareEntry atc) {
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">    if (atc == null</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">        || isBlank(serviceName(atc))</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        || allBlank(waitTimeNumber(atc.newWaitTime()), waitTimeNumber(atc.estWaitTime()))) {</span>
<span class="fc" id="L83">      return null;</span>
    }
<span class="fc" id="L85">    return Facility.PatientWaitTime.builder()</span>
<span class="fc" id="L86">        .service(serviceName(atc))</span>
<span class="fc" id="L87">        .newPatientWaitTime(waitTimeNumber(atc.newWaitTime()))</span>
<span class="fc" id="L88">        .establishedPatientWaitTime(waitTimeNumber(atc.estWaitTime()))</span>
<span class="fc" id="L89">        .build();</span>
  }

  private static BigDecimal waitTimeNumber(BigDecimal waitTime) {
<span class="pc bpc" id="L93" title="2 of 4 branches missed.">    if (waitTime == null || waitTime.compareTo(new BigDecimal(&quot;999&quot;)) &gt;= 0) {</span>
<span class="nc" id="L94">      return null;</span>
    }
<span class="fc" id="L96">    return waitTime;</span>
  }

  private List&lt;AccessToCareEntry&gt; accessToCareEntries() {
<span class="fc" id="L100">    return accessToCare.get(trimToEmpty(upperCase(id(), Locale.US)));</span>
  }

  private List&lt;AccessToPwtEntry&gt; accessToPwtEntries() {
<span class="fc" id="L104">    return accessToPwt.get(trimToEmpty(upperCase(id(), Locale.US)));</span>
  }

  private Facility.ActiveStatus activeStatus() {
<span class="fc bfc" id="L108" title="All 2 branches covered.">    if (allBlank(vast.pod())) {</span>
<span class="fc" id="L109">      return null;</span>
    }
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">    return vast.pod().equalsIgnoreCase(&quot;A&quot;) ? Facility.ActiveStatus.A : Facility.ActiveStatus.T;</span>
  }

  private Facility.Addresses address() {
<span class="fc bfc" id="L115" title="All 2 branches covered.">    if (allBlank(physical())) {</span>
<span class="fc" id="L116">      return null;</span>
    }
<span class="fc" id="L118">    return Facility.Addresses.builder().physical(physical()).build();</span>
  }

  private LocalDate atcEffectiveDate() {
<span class="fc" id="L122">    return accessToCareEntries().stream()</span>
<span class="fc" id="L123">        .map(ace -&gt; sliceToDate(ace.sliceEndDate()))</span>
<span class="fc" id="L124">        .filter(Objects::nonNull)</span>
<span class="fc" id="L125">        .sorted(Comparator.reverseOrder())</span>
<span class="fc" id="L126">        .findFirst()</span>
<span class="fc" id="L127">        .orElse(null);</span>
  }

  private LocalDate atpEffectiveDate() {
<span class="fc" id="L131">    return accessToPwtEntries().stream()</span>
<span class="fc" id="L132">        .map(ape -&gt; sliceToDate(ape.sliceEndDate()))</span>
<span class="fc" id="L133">        .filter(Objects::nonNull)</span>
<span class="fc" id="L134">        .sorted(Comparator.reverseOrder())</span>
<span class="fc" id="L135">        .findFirst()</span>
<span class="fc" id="L136">        .orElse(null);</span>
  }

  private Facility.FacilityAttributes attributes() {
<span class="fc bfc" id="L140" title="All 2 branches covered.">    if (allBlank(</span>
<span class="fc" id="L141">        vast.stationName(),</span>
<span class="fc" id="L142">        classification(),</span>
<span class="fc" id="L143">        website(),</span>
<span class="fc" id="L144">        vast.latitude(),</span>
<span class="fc" id="L145">        vast.longitude(),</span>
<span class="fc" id="L146">        address(),</span>
<span class="fc" id="L147">        phone(),</span>
<span class="fc" id="L148">        hours(),</span>
<span class="fc" id="L149">        vast.operationalHoursSpecialInstructions(),</span>
<span class="fc" id="L150">        services(),</span>
<span class="fc" id="L151">        satisfaction(),</span>
<span class="fc" id="L152">        waitTimes(),</span>
<span class="fc" id="L153">        vast.mobile(),</span>
<span class="fc" id="L154">        activeStatus(),</span>
<span class="fc" id="L155">        vast.visn())) {</span>
<span class="fc" id="L156">      return null;</span>
    }
<span class="fc" id="L158">    return Facility.FacilityAttributes.builder()</span>
<span class="fc" id="L159">        .name(vast.stationName())</span>
<span class="fc" id="L160">        .facilityType(Facility.FacilityType.va_health_facility)</span>
<span class="fc" id="L161">        .classification(classification())</span>
<span class="fc" id="L162">        .website(website())</span>
<span class="fc" id="L163">        .latitude(vast.latitude())</span>
<span class="fc" id="L164">        .longitude(vast.longitude())</span>
<span class="fc" id="L165">        .timeZone(CalculateTimeZone.calculateTimeZones(vast.latitude(), vast.longitude()))</span>
<span class="fc" id="L166">        .address(address())</span>
<span class="fc" id="L167">        .phone(phone())</span>
<span class="fc" id="L168">        .hours(hours())</span>
<span class="fc" id="L169">        .operationalHoursSpecialInstructions(vast.operationalHoursSpecialInstructions())</span>
<span class="fc" id="L170">        .services(services())</span>
<span class="fc" id="L171">        .satisfaction(satisfaction())</span>
<span class="fc" id="L172">        .waitTimes(waitTimes())</span>
<span class="fc" id="L173">        .mobile(vast.mobile())</span>
<span class="fc" id="L174">        .activeStatus(activeStatus())</span>
<span class="fc" id="L175">        .visn(vast.visn())</span>
<span class="fc" id="L176">        .build();</span>
  }

  String classification() {
<span class="fc bfc" id="L180" title="All 8 branches covered.">    switch (trimToEmpty(vast.cocClassificationId())) {</span>
      case &quot;1&quot;:
<span class="fc" id="L182">        return &quot;VA Medical Center (VAMC)&quot;;</span>
      case &quot;2&quot;:
<span class="fc" id="L184">        return &quot;Health Care Center (HCC)&quot;;</span>
      case &quot;3&quot;:
<span class="fc" id="L186">        return &quot;Multi-Specialty CBOC&quot;;</span>
      case &quot;4&quot;:
<span class="fc" id="L188">        return &quot;Primary Care CBOC&quot;;</span>
      case &quot;5&quot;:
<span class="fc" id="L190">        return &quot;Other Outpatient Services (OOS)&quot;;</span>
      case &quot;7&quot;:
<span class="fc" id="L192">        return &quot;Residential Care Site (MH RRTP/DRRTP) (Stand-Alone)&quot;;</span>
      case &quot;8&quot;:
<span class="fc" id="L194">        return &quot;Extended Care Site (Community Living Center) (Stand-Alone)&quot;;</span>
      default:
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (isNotBlank(vast.cocClassificationId())) {</span>
<span class="fc" id="L197">          return vast.cocClassificationId();</span>
        }
<span class="fc" id="L199">        return vast.abbreviation();</span>
    }
  }

  boolean hasCaregiverSupport() {
<span class="pc bpc" id="L204" title="1 of 4 branches missed.">    return !allBlank(id()) &amp;&amp; cscFacilities.contains(id());</span>
  }

  private Facility.Hours hours() {
<span class="fc" id="L208">    String mon = hoursToClosed(vast.monday());</span>
<span class="fc" id="L209">    String tue = hoursToClosed(vast.tuesday());</span>
<span class="fc" id="L210">    String wed = hoursToClosed(vast.wednesday());</span>
<span class="fc" id="L211">    String thu = hoursToClosed(vast.thursday());</span>
<span class="fc" id="L212">    String fri = hoursToClosed(vast.friday());</span>
<span class="fc" id="L213">    String sat = hoursToClosed(vast.saturday());</span>
<span class="fc" id="L214">    String sun = hoursToClosed(vast.sunday());</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">    if (allBlank(mon, tue, wed, thu, fri, sat, sun)) {</span>
<span class="fc" id="L216">      return null;</span>
    }
<span class="fc" id="L218">    return Facility.Hours.builder()</span>
<span class="fc" id="L219">        .monday(mon)</span>
<span class="fc" id="L220">        .tuesday(tue)</span>
<span class="fc" id="L221">        .wednesday(wed)</span>
<span class="fc" id="L222">        .thursday(thu)</span>
<span class="fc" id="L223">        .friday(fri)</span>
<span class="fc" id="L224">        .saturday(sat)</span>
<span class="fc" id="L225">        .sunday(sun)</span>
<span class="fc" id="L226">        .build();</span>
  }

  private String id() {
<span class="fc bfc" id="L230" title="All 2 branches covered.">    if (allBlank(vast.stationNumber())) {</span>
<span class="fc" id="L231">      return null;</span>
    }
<span class="fc" id="L233">    return &quot;vha_&quot; + vast.stationNumber();</span>
  }

  private Facility.Phone phone() {
<span class="fc" id="L237">    String fax = phoneTrim(vast.staFax());</span>
<span class="fc" id="L238">    String main = phoneTrim(vast.staPhone());</span>
<span class="fc" id="L239">    String pharmacy = phoneTrim(vast.pharmacyPhone());</span>
<span class="fc" id="L240">    String afterHours = phoneTrim(vast.afterHoursPhone());</span>
<span class="fc" id="L241">    String patientAdvocate = phoneTrim(vast.patientAdvocatePhone());</span>
<span class="fc" id="L242">    String mentalHealth = phoneTrim(mentalHealthPhoneNumbers.get(id()));</span>
<span class="fc" id="L243">    String enrollmentCoordinator = phoneTrim(vast.enrollmentCoordinatorPhone());</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">    if (allBlank(</span>
        fax, main, pharmacy, afterHours, patientAdvocate, mentalHealth, enrollmentCoordinator)) {
<span class="fc" id="L246">      return null;</span>
    }
<span class="fc" id="L248">    return Facility.Phone.builder()</span>
<span class="fc" id="L249">        .fax(fax)</span>
<span class="fc" id="L250">        .main(main)</span>
<span class="fc" id="L251">        .pharmacy(pharmacy)</span>
<span class="fc" id="L252">        .afterHours(afterHours)</span>
<span class="fc" id="L253">        .patientAdvocate(patientAdvocate)</span>
<span class="fc" id="L254">        .mentalHealthClinic(mentalHealth)</span>
<span class="fc" id="L255">        .enrollmentCoordinator(enrollmentCoordinator)</span>
<span class="fc" id="L256">        .build();</span>
  }

  private Facility.Address physical() {
<span class="fc bfc" id="L260" title="All 2 branches covered.">    if (allBlank(</span>
<span class="fc" id="L261">        zip(),</span>
<span class="fc" id="L262">        vast.city(),</span>
<span class="fc" id="L263">        vast.state(),</span>
<span class="fc" id="L264">        checkAngleBracketNull(vast.address2()),</span>
<span class="fc" id="L265">        checkAngleBracketNull(vast.address1()),</span>
<span class="fc" id="L266">        checkAngleBracketNull(vast.address3()))) {</span>
<span class="fc" id="L267">      return null;</span>
    }
    // address1 and address2 swapped
<span class="fc" id="L270">    return Facility.Address.builder()</span>
<span class="fc" id="L271">        .zip(zip())</span>
<span class="fc" id="L272">        .city(vast.city())</span>
<span class="fc" id="L273">        .state(upperCase(vast.state(), Locale.US))</span>
<span class="fc" id="L274">        .address1(checkAngleBracketNull(vast.address2()))</span>
<span class="fc" id="L275">        .address2(checkAngleBracketNull(vast.address1()))</span>
<span class="fc" id="L276">        .address3(checkAngleBracketNull(vast.address3()))</span>
<span class="fc" id="L277">        .build();</span>
  }

  private Facility.Satisfaction satisfaction() {
<span class="fc bfc" id="L281" title="All 2 branches covered.">    if (allBlank(satisfactionScores(), atpEffectiveDate())) {</span>
<span class="fc" id="L282">      return null;</span>
    }
<span class="fc" id="L284">    return Facility.Satisfaction.builder()</span>
<span class="fc" id="L285">        .health(satisfactionScores())</span>
<span class="fc" id="L286">        .effectiveDate(atpEffectiveDate())</span>
<span class="fc" id="L287">        .build();</span>
  }

  private BigDecimal satisfactionScore(String type) {
<span class="fc" id="L291">    return accessToPwtEntries().stream()</span>
<span class="fc" id="L292">        .filter(atp -&gt; equalsIgnoreCase(atp.apptTypeName(), type))</span>
<span class="fc" id="L293">        .map(atp -&gt; atp.shepScore())</span>
<span class="fc" id="L294">        .min(Comparator.naturalOrder())</span>
<span class="fc" id="L295">        .orElse(null);</span>
  }

  private Facility.PatientSatisfaction satisfactionScores() {
<span class="fc bfc" id="L299" title="All 2 branches covered.">    if (allBlank(</span>
<span class="fc" id="L300">        satisfactionScore(&quot;Primary Care (Urgent)&quot;),</span>
<span class="fc" id="L301">        satisfactionScore(&quot;Primary Care (Routine)&quot;),</span>
<span class="fc" id="L302">        satisfactionScore(&quot;Specialty Care (Urgent)&quot;),</span>
<span class="fc" id="L303">        satisfactionScore(&quot;Specialty Care (Routine)&quot;))) {</span>
<span class="fc" id="L304">      return null;</span>
    }
<span class="fc" id="L306">    return Facility.PatientSatisfaction.builder()</span>
<span class="fc" id="L307">        .primaryCareUrgent(satisfactionScore(&quot;Primary Care (Urgent)&quot;))</span>
<span class="fc" id="L308">        .primaryCareRoutine(satisfactionScore(&quot;Primary Care (Routine)&quot;))</span>
<span class="fc" id="L309">        .specialtyCareUrgent(satisfactionScore(&quot;Specialty Care (Urgent)&quot;))</span>
<span class="fc" id="L310">        .specialtyCareRoutine(satisfactionScore(&quot;Specialty Care (Routine)&quot;))</span>
<span class="fc" id="L311">        .build();</span>
  }

  private Facility.Services services() {
<span class="fc bfc" id="L315" title="All 2 branches covered.">    if (allBlank(servicesHealth(), atcEffectiveDate())) {</span>
<span class="fc" id="L316">      return null;</span>
    }
<span class="fc" id="L318">    return Facility.Services.builder()</span>
<span class="fc" id="L319">        .health(servicesHealth())</span>
<span class="fc" id="L320">        .lastUpdated(atcEffectiveDate())</span>
<span class="fc" id="L321">        .build();</span>
  }

  private List&lt;Facility.HealthService&gt; servicesHealth() {
<span class="fc" id="L325">    List&lt;Facility.HealthService&gt; services =</span>
<span class="fc" id="L326">        accessToCareEntries().stream()</span>
<span class="fc" id="L327">            .map(ace -&gt; serviceName(ace))</span>
<span class="fc" id="L328">            .filter(Objects::nonNull)</span>
<span class="fc" id="L329">            .collect(toCollection(ArrayList::new));</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">    if (accessToCareEntries().stream().anyMatch(ace -&gt; BooleanUtils.isTrue(ace.emergencyCare()))) {</span>
<span class="fc" id="L331">      services.add(Facility.HealthService.EmergencyCare);</span>
    }
<span class="fc bfc" id="L333" title="All 2 branches covered.">    if (accessToCareEntries().stream().anyMatch(ace -&gt; BooleanUtils.isTrue(ace.urgentCare()))) {</span>
<span class="fc" id="L334">      services.add(Facility.HealthService.UrgentCare);</span>
    }
<span class="fc bfc" id="L336" title="All 2 branches covered.">    if (stopCodes().stream().anyMatch(sc -&gt; StopCode.DENTISTRY.contains(trimToEmpty(sc.code())))) {</span>
<span class="fc" id="L337">      services.add(Facility.HealthService.DentalServices);</span>
    }
<span class="fc bfc" id="L339" title="All 2 branches covered.">    if (stopCodes().stream().anyMatch(sc -&gt; StopCode.NUTRITION.contains(trimToEmpty(sc.code())))) {</span>
<span class="fc" id="L340">      services.add(Facility.HealthService.Nutrition);</span>
    }
<span class="fc bfc" id="L342" title="All 2 branches covered.">    if (stopCodes().stream().anyMatch(sc -&gt; StopCode.PODIATRY.contains(trimToEmpty(sc.code())))) {</span>
<span class="fc" id="L343">      services.add(Facility.HealthService.Podiatry);</span>
    }
<span class="fc bfc" id="L345" title="All 2 branches covered.">    if (hasCaregiverSupport()) {</span>
<span class="fc" id="L346">      services.add(Facility.HealthService.CaregiverSupport);</span>
    }
<span class="fc" id="L348">    Collections.sort(services, (left, right) -&gt; left.name().compareToIgnoreCase(right.name()));</span>
<span class="fc" id="L349">    return emptyToNull(services);</span>
  }

  private List&lt;StopCode&gt; stopCodes() {
<span class="fc" id="L353">    return stopCodesMap.get(trimToEmpty(upperCase(id(), Locale.US)));</span>
  }

  Facility toFacility() {
<span class="fc bfc" id="L357" title="All 2 branches covered.">    if (allBlank(id())) {</span>
<span class="fc" id="L358">      return null;</span>
    }
<span class="fc" id="L360">    return Facility.builder()</span>
<span class="fc" id="L361">        .id(id())</span>
<span class="fc" id="L362">        .type(Facility.Type.va_facilities)</span>
<span class="fc" id="L363">        .attributes(attributes())</span>
<span class="fc" id="L364">        .build();</span>
  }

  private Facility.WaitTimes waitTimes() {
<span class="fc bfc" id="L368" title="All 2 branches covered.">    if (allBlank(waitTimesHealth(), atcEffectiveDate())) {</span>
<span class="fc" id="L369">      return null;</span>
    }
<span class="fc" id="L371">    return Facility.WaitTimes.builder()</span>
<span class="fc" id="L372">        .health(waitTimesHealth())</span>
<span class="fc" id="L373">        .effectiveDate(atcEffectiveDate())</span>
<span class="fc" id="L374">        .build();</span>
  }

  private List&lt;Facility.PatientWaitTime&gt; waitTimesHealth() {
<span class="fc" id="L378">    List&lt;PatientWaitTime&gt; results =</span>
<span class="fc" id="L379">        accessToCareEntries().stream()</span>
<span class="fc" id="L380">            .map(ace -&gt; waitTime(ace))</span>
<span class="fc" id="L381">            .filter(Objects::nonNull)</span>
<span class="fc" id="L382">            .collect(toCollection(ArrayList::new));</span>
<span class="fc" id="L383">    Collections.sort(</span>
<span class="nc" id="L384">        results, (left, right) -&gt; compareIgnoreCase(left.service().name(), right.service().name()));</span>
<span class="fc" id="L385">    return emptyToNull(results);</span>
  }

  String website() {
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">    return allBlank(id()) ? null : websites.get(id());</span>
  }

  private String zip() {
<span class="fc" id="L393">    String zip = vast.zip();</span>
<span class="fc" id="L394">    String zipPlus4 = vast.zip4();</span>
<span class="pc bpc" id="L395" title="2 of 6 branches missed.">    if (isNotBlank(zip) &amp;&amp; isNotBlank(zipPlus4) &amp;&amp; !zipPlus4.matches(&quot;^[0]+$&quot;)) {</span>
<span class="nc" id="L396">      return zip + &quot;-&quot; + zipPlus4;</span>
    }
<span class="fc" id="L398">    return zip;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>