<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FacilitiesCollector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">facilities</a> &gt; <a href="index.source.html" class="el_package">gov.va.api.lighthouse.facilities.collector</a> &gt; <span class="el_source">FacilitiesCollector.java</span></div><h1>FacilitiesCollector.java</h1><pre class="source lang-java linenums">package gov.va.api.lighthouse.facilities.collector;

import static com.google.common.base.Preconditions.checkState;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.lang3.StringUtils.trimToNull;

import com.google.common.base.Stopwatch;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.Iterables;
import com.google.common.collect.Streams;
import gov.va.api.lighthouse.facilities.api.v0.Facility;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.TreeMap;
import java.util.concurrent.TimeUnit;
import lombok.NonNull;
import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVRecord;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ClassPathResource;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

<span class="fc" id="L35">@Slf4j</span>
@Component
public class FacilitiesCollector {
  private static final String WEBSITES_CSV_RESOURCE_NAME = &quot;websites.csv&quot;;

  private static final String CSC_STATIONS_RESOURCE_NAME = &quot;csc_stations.txt&quot;;

  private final InsecureRestTemplateProvider insecureRestTemplateProvider;

  private final JdbcTemplate jdbcTemplate;

  private final String atcBaseUrl;

  private final String atpBaseUrl;

  private final String cemeteriesBaseUrl;

  /** Autowired constructor. */
  public FacilitiesCollector(
      @Autowired InsecureRestTemplateProvider insecureRestTemplateProvider,
      @Autowired JdbcTemplate jdbcTemplate,
      @Value(&quot;${access-to-care.url}&quot;) String atcBaseUrl,
      @Value(&quot;${access-to-pwt.url}&quot;) String atpBaseUrl,
<span class="fc" id="L58">      @Value(&quot;${cemeteries.url}&quot;) String cemeteriesBaseUrl) {</span>
<span class="fc" id="L59">    this.insecureRestTemplateProvider = insecureRestTemplateProvider;</span>
<span class="fc" id="L60">    this.jdbcTemplate = jdbcTemplate;</span>
<span class="fc" id="L61">    this.atcBaseUrl = withTrailingSlash(atcBaseUrl);</span>
<span class="fc" id="L62">    this.atpBaseUrl = withTrailingSlash(atpBaseUrl);</span>
<span class="fc" id="L63">    this.cemeteriesBaseUrl = withTrailingSlash(cemeteriesBaseUrl);</span>
<span class="fc" id="L64">  }</span>

  /** Caregiver support facilities given a resource name. */
<span class="nc" id="L67">  @SneakyThrows</span>
  public static ArrayList&lt;String&gt; loadCaregiverSupport(String resourceName) {
<span class="fc" id="L69">    final Stopwatch totalWatch = Stopwatch.createStarted();</span>

<span class="fc" id="L71">    ArrayList&lt;String&gt; cscFacilities = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L73">    try (BufferedReader reader =</span>
        new BufferedReader(
            new InputStreamReader(
<span class="fc" id="L76">                new ClassPathResource(resourceName).getInputStream(), StandardCharsets.UTF_8))) {</span>
      String line;
<span class="fc bfc" id="L78" title="All 2 branches covered.">      while ((line = reader.readLine()) != null) {</span>
<span class="fc" id="L79">        cscFacilities.add(&quot;vha_&quot; + line);</span>
      }
    }

<span class="fc" id="L83">    log.info(</span>
        &quot;Loading caregiver support facilities took {} millis for {} entries&quot;,
<span class="fc" id="L85">        totalWatch.stop().elapsed(TimeUnit.MILLISECONDS),</span>
<span class="fc" id="L86">        cscFacilities.size());</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">    checkState(!cscFacilities.isEmpty(), &quot;No caregiver support entries&quot;);</span>
<span class="fc" id="L88">    return cscFacilities;</span>
  }

  /** Load websites given a resource name. */
<span class="nc" id="L92">  @SneakyThrows</span>
  public static Map&lt;String, String&gt; loadWebsites(String resourceName) {
<span class="fc" id="L94">    final Stopwatch totalWatch = Stopwatch.createStarted();</span>
<span class="fc" id="L95">    try (InputStreamReader reader =</span>
        new InputStreamReader(
<span class="fc" id="L97">            new ClassPathResource(resourceName).getInputStream(), StandardCharsets.UTF_8)) {</span>
<span class="fc" id="L98">      Iterable&lt;CSVRecord&gt; rows = CSVFormat.DEFAULT.withFirstRecordAsHeader().parse(reader);</span>
<span class="fc" id="L99">      Map&lt;String, String&gt; map = new TreeMap&lt;&gt;(String.CASE_INSENSITIVE_ORDER);</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">      for (CSVRecord row : rows) {</span>
<span class="fc" id="L101">        String id = trimToNull(row.get(&quot;id&quot;));</span>
<span class="fc" id="L102">        String url = trimToNull(row.get(&quot;url&quot;));</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        checkState(id != null, &quot;Website %s missing ID&quot;, url);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">        checkState(url != null, &quot;Website %s missing url&quot;, id);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        checkState(!map.containsKey(id), &quot;Website %s duplicate&quot;, id);</span>
<span class="fc" id="L106">        map.put(id, url);</span>
<span class="fc" id="L107">      }</span>
<span class="fc" id="L108">      Map&lt;String, String&gt; websites = Collections.unmodifiableMap(map);</span>
<span class="fc" id="L109">      log.info(</span>
          &quot;Loading websites took {} millis for {} entries&quot;,
<span class="fc" id="L111">          totalWatch.stop().elapsed(TimeUnit.MILLISECONDS),</span>
<span class="fc" id="L112">          websites.size());</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">      checkState(!websites.isEmpty(), &quot;No website entries&quot;);</span>
<span class="fc" id="L114">      return websites;</span>
    }
  }

<span class="nc" id="L118">  @SneakyThrows</span>
  static VastEntity toVastEntity(ResultSet rs) {
<span class="fc" id="L120">    return VastEntity.builder()</span>
<span class="fc" id="L121">        .vetCenter(rs.getBoolean(&quot;VCTR2&quot;))</span>
<span class="fc" id="L122">        .mobileVetCenter(rs.getBoolean(&quot;MVCTR&quot;))</span>
<span class="fc" id="L123">        .latitude(rs.getBigDecimal(&quot;LAT&quot;))</span>
<span class="fc" id="L124">        .longitude(rs.getBigDecimal(&quot;LON&quot;))</span>
<span class="fc" id="L125">        .stationNumber(rs.getString(&quot;STA_NO&quot;))</span>
<span class="fc" id="L126">        .stationName(rs.getString(&quot;STATIONNAME&quot;))</span>
<span class="fc" id="L127">        .abbreviation(rs.getString(&quot;S_ABBR&quot;))</span>
<span class="fc" id="L128">        .cocClassificationId(rs.getString(&quot;COCCLASSIFICATIONID&quot;))</span>
<span class="fc" id="L129">        .address1(rs.getString(&quot;ADDRESS1&quot;))</span>
<span class="fc" id="L130">        .address2(rs.getString(&quot;ADDRESS2&quot;))</span>
<span class="fc" id="L131">        .address3(rs.getString(&quot;ADDRESS3&quot;))</span>
<span class="fc" id="L132">        .city(rs.getString(&quot;CITY&quot;))</span>
<span class="fc" id="L133">        .state(rs.getString(&quot;ST&quot;))</span>
<span class="fc" id="L134">        .zip(rs.getString(&quot;zip&quot;))</span>
<span class="fc" id="L135">        .zip4(rs.getString(&quot;ZIP4&quot;))</span>
<span class="fc" id="L136">        .monday(rs.getString(&quot;MONDAY&quot;))</span>
<span class="fc" id="L137">        .tuesday(rs.getString(&quot;TUESDAY&quot;))</span>
<span class="fc" id="L138">        .wednesday(rs.getString(&quot;WEDNESDAY&quot;))</span>
<span class="fc" id="L139">        .thursday(rs.getString(&quot;THURSDAY&quot;))</span>
<span class="fc" id="L140">        .friday(rs.getString(&quot;FRIDAY&quot;))</span>
<span class="fc" id="L141">        .saturday(rs.getString(&quot;SATURDAY&quot;))</span>
<span class="fc" id="L142">        .sunday(rs.getString(&quot;SUNDAY&quot;))</span>
<span class="fc" id="L143">        .staPhone(rs.getString(&quot;STA_PHONE&quot;))</span>
<span class="fc" id="L144">        .staFax(rs.getString(&quot;STA_FAX&quot;))</span>
<span class="fc" id="L145">        .afterHoursPhone(rs.getString(&quot;AFTERHOURSPHONE&quot;))</span>
<span class="fc" id="L146">        .patientAdvocatePhone(rs.getString(&quot;PATIENTADVOCATEPHONE&quot;))</span>
<span class="fc" id="L147">        .enrollmentCoordinatorPhone(rs.getString(&quot;ENROLLMENTCOORDINATORPHONE&quot;))</span>
<span class="fc" id="L148">        .pharmacyPhone(rs.getString(&quot;PHARMACYPHONE&quot;))</span>
<span class="fc" id="L149">        .pod(rs.getString(&quot;POD&quot;))</span>
<span class="fc" id="L150">        .mobile(rs.getBoolean(&quot;MOBILE&quot;))</span>
<span class="fc" id="L151">        .visn(rs.getString(&quot;VISN&quot;))</span>
<span class="fc" id="L152">        .lastUpdated(</span>
<span class="fc" id="L153">            Optional.ofNullable(rs.getTimestamp(&quot;LASTUPDATED&quot;))</span>
<span class="pc" id="L154">                .map(t -&gt; t.toInstant())</span>
<span class="fc" id="L155">                .orElse(null))</span>
<span class="fc" id="L156">        .operationalHoursSpecialInstructions(rs.getString(&quot;OPERATIONALHOURSSPECIALINSTRUCTIONS&quot;))</span>
<span class="fc" id="L157">        .build();</span>
  }

<span class="pc bpc" id="L160" title="1 of 2 branches missed.">  static String withTrailingSlash(@NonNull String url) {</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">    return url.endsWith(&quot;/&quot;) ? url : url + &quot;/&quot;;</span>
  }

  /** Collect facilities. */
<span class="nc" id="L165">  @SneakyThrows</span>
  public List&lt;Facility&gt; collectFacilities() {
    Map&lt;String, String&gt; websites;
    Collection&lt;VastEntity&gt; vastEntities;
    ArrayList&lt;String&gt; cscFacilities;

    try {
<span class="fc" id="L172">      websites = loadWebsites(WEBSITES_CSV_RESOURCE_NAME);</span>
<span class="fc" id="L173">      vastEntities = loadVast();</span>
<span class="fc" id="L174">      cscFacilities = loadCaregiverSupport(CSC_STATIONS_RESOURCE_NAME);</span>

<span class="nc" id="L176">    } catch (Exception e) {</span>
<span class="nc" id="L177">      throw new CollectorExceptions.CollectorException(e);</span>
<span class="fc" id="L178">    }</span>

    Collection&lt;Facility&gt; healths =
<span class="fc" id="L181">        HealthsCollector.builder()</span>
<span class="fc" id="L182">            .atcBaseUrl(atcBaseUrl)</span>
<span class="fc" id="L183">            .atpBaseUrl(atpBaseUrl)</span>
<span class="fc" id="L184">            .cscFacilities(cscFacilities)</span>
<span class="fc" id="L185">            .jdbcTemplate(jdbcTemplate)</span>
<span class="fc" id="L186">            .insecureRestTemplate(insecureRestTemplateProvider.restTemplate())</span>
<span class="fc" id="L187">            .vastEntities(vastEntities)</span>
<span class="fc" id="L188">            .websites(websites)</span>
<span class="fc" id="L189">            .build()</span>
<span class="fc" id="L190">            .collect();</span>

    Collection&lt;Facility&gt; stateCems =
<span class="fc" id="L193">        StateCemeteriesCollector.builder()</span>
<span class="fc" id="L194">            .baseUrl(cemeteriesBaseUrl)</span>
<span class="fc" id="L195">            .insecureRestTemplate(insecureRestTemplateProvider.restTemplate())</span>
<span class="fc" id="L196">            .websites(websites)</span>
<span class="fc" id="L197">            .build()</span>
<span class="fc" id="L198">            .collect();</span>

    Collection&lt;Facility&gt; vetCenters =
<span class="fc" id="L201">        VetCentersCollector.builder()</span>
<span class="fc" id="L202">            .vastEntities(vastEntities)</span>
<span class="fc" id="L203">            .websites(websites)</span>
<span class="fc" id="L204">            .build()</span>
<span class="fc" id="L205">            .collect();</span>

    Collection&lt;Facility&gt; benefits =
<span class="fc" id="L208">        BenefitsCollector.builder().websites(websites).jdbcTemplate(jdbcTemplate).build().collect();</span>

    Collection&lt;Facility&gt; cemeteries =
<span class="fc" id="L211">        CemeteriesCollector.builder()</span>
<span class="fc" id="L212">            .baseUrl(cemeteriesBaseUrl)</span>
<span class="fc" id="L213">            .insecureRestTemplate(insecureRestTemplateProvider.restTemplate())</span>
<span class="fc" id="L214">            .websites(websites)</span>
<span class="fc" id="L215">            .jdbcTemplate(jdbcTemplate)</span>
<span class="fc" id="L216">            .build()</span>
<span class="fc" id="L217">            .collect();</span>

<span class="fc" id="L219">    log.info(</span>
        &quot;Collected: Health {},  Benefits {},  Vet centers {}, &quot;
            + &quot;Non-national cemeteries {}, Cemeteries {}&quot;,
<span class="fc" id="L222">        healths.size(),</span>
<span class="fc" id="L223">        benefits.size(),</span>
<span class="fc" id="L224">        vetCenters.size(),</span>
<span class="fc" id="L225">        stateCems.size(),</span>
<span class="fc" id="L226">        cemeteries.size());</span>

<span class="fc" id="L228">    return Streams.stream(Iterables.concat(benefits, cemeteries, healths, stateCems, vetCenters))</span>
<span class="fc" id="L229">        .sorted((left, right) -&gt; left.id().compareToIgnoreCase(right.id()))</span>
<span class="fc" id="L230">        .collect(toList());</span>
  }

  private List&lt;VastEntity&gt; loadVast() {
<span class="fc" id="L234">    Stopwatch watch = Stopwatch.createStarted();</span>
<span class="fc" id="L235">    List&lt;VastEntity&gt; entities =</span>
<span class="fc" id="L236">        ImmutableList.copyOf(</span>
<span class="fc" id="L237">            jdbcTemplate.query(</span>
                &quot;SELECT &quot;
                    + &quot;VCTR2,&quot;
                    + &quot;MVCTR,&quot;
                    + &quot;LAT,&quot;
                    + &quot;LON,&quot;
                    + &quot;STA_NO,&quot;
                    + &quot;STATIONNAME,&quot;
                    + &quot;S_ABBR,&quot;
                    + &quot;COCCLASSIFICATIONID,&quot;
                    + &quot;ADDRESS1,&quot;
                    + &quot;ADDRESS2,&quot;
                    + &quot;ADDRESS3,&quot;
                    + &quot;CITY,&quot;
                    + &quot;ST,&quot;
                    + &quot;ZIP,&quot;
                    + &quot;ZIP4,&quot;
                    + &quot;MONDAY,&quot;
                    + &quot;TUESDAY,&quot;
                    + &quot;WEDNESDAY,&quot;
                    + &quot;THURSDAY,&quot;
                    + &quot;FRIDAY,&quot;
                    + &quot;SATURDAY,&quot;
                    + &quot;SUNDAY,&quot;
                    + &quot;OPERATIONALHOURSSPECIALINSTRUCTIONS,&quot;
                    + &quot;STA_PHONE,&quot;
                    + &quot;STA_FAX,&quot;
                    + &quot;AFTERHOURSPHONE,&quot;
                    + &quot;PATIENTADVOCATEPHONE,&quot;
                    + &quot;ENROLLMENTCOORDINATORPHONE,&quot;
                    + &quot;PHARMACYPHONE,&quot;
                    + &quot;POD,&quot;
                    + &quot;MOBILE,&quot;
                    + &quot;VISN,&quot;
                    + &quot;LASTUPDATED&quot;
                    + &quot; FROM App.Vast&quot;,
<span class="fc" id="L273">                (rs, rowNum) -&gt; toVastEntity(rs)));</span>

<span class="fc" id="L275">    log.info(</span>
        &quot;Loading VAST took {} millis for {} entries&quot;,
<span class="fc" id="L277">        watch.stop().elapsed(TimeUnit.MILLISECONDS),</span>
<span class="fc" id="L278">        entities.size());</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">    checkState(!entities.isEmpty(), &quot;No App.Vast entries&quot;);</span>
<span class="fc" id="L280">    return entities;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>